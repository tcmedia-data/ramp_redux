SELECT Mth__filter,Site,SiteID,Platform_NAME,Creative_size_Final
,Total_impressions
,Imps_Final
,CASE WHEN Imps_Final_Sizeless < 0 THEN 0 
ELSE Imps_Final_Sizeless END AS Imps_Final_Sizeless
FROM (

SELECT Mth__filter,Site,SiteID,Platform_NAME,Creative_size_Final
,SUM(Total_impressions) AS Total_impressions
,SUM(Imps_Final) AS Imps_Final
,SUM(Imps_RunningTotal) AS Imps_RunningTotal
,SUM(Imps_Final_Sizeless) AS Imps_Final_Sizeless
FROM (

SELECT Mth__filter,Site,SiteID,Platform_NAME,Creative_size_Final
,Total_impressions
,Imps_Final
,Imps_RunningTotal
,CASE WHEN Creative_size_Final ='sizeless' AND Platform_NAME = 'DFP' THEN Imps_RunningTotal6 
 WHEN Creative_size_Final NOT LIKE '%sizeless%' AND Platform_NAME = 'AppNexus' THEN Imps_RunningTotal3
 ELSE Imps_RunningTotal3 END AS Imps_Final_Sizeless
FROM (

SELECT Mth__filter,Site,SiteID,Platform_NAME,Creative_size_Final
,Total_impressions
,Imps_Final
,Imps_RunningTotal
,Imps_RunningTotal2
,Imps_RunningTotal3
,Imps_RunningTotal4
,Imps_RunningTotal5
,(MAX(Imps_RunningTotal4)-MAX(Imps_RunningTotal5)) AS Imps_RunningTotal6

FROM (

////E
SELECT Mth__filter,Site,SiteID,Platform_NAME,Creative_size_Final
,Total_impressions
,Imps_Final
,Imps_RunningTotal
,SUM(Imps_RunningTotal2) AS Imps_RunningTotal2
,SUM(Imps_RunningTotal3) AS Imps_RunningTotal3
,SUM(Imps_RunningTotal2) OVER (PARTITION BY SiteID,Mth__filter) AS Imps_RunningTotal4
,SUM(Imps_RunningTotal3) OVER (PARTITION BY SiteID,Mth__filter) AS Imps_RunningTotal5
//,SUM(Revs_CPMCPC_Final) AS Revs_CPMCPC_Final 
FROM (

SELECT Mth__filter,Site,SiteID,Platform_NAME,Creative_size_Final
,Total_impressions
,Imps_Final
,Imps_RunningTotal
,CASE WHEN Creative_size_Final ='sizeless' AND Platform_NAME = 'DFP' THEN Imps_Final 
ELSE 0 END AS Imps_RunningTotal2
,CASE WHEN Creative_size_Final <>'sizeless' AND Platform_NAME <> 'DFP' THEN Imps_Final 
ELSE 0 END AS Imps_RunningTotal3
//,SUM(Revs_CPMCPC_Final) AS Revs_CPMCPC_Final 
FROM (

SELECT * FROM (
//AS B

SELECT Mth__filter,Site,SiteID,Platform_NAME,Creative_size_Final
,SUM(Total_impressions) AS Total_impressions
,SUM(Imps_Final) AS Imps_Final
,SUM(Imps_Final) OVER(PARTITION BY SiteID,Mth__filter) AS Imps_RunningTotal
FROM (

SELECT 
        CASE
           WHEN MONTH(Transaction_Date) = 1 THEN "01 - Jan"
           WHEN MONTH(Transaction_Date) = 2 THEN "02 - Feb"
           WHEN MONTH(Transaction_Date) = 3 THEN "03 - Mar"
           WHEN MONTH(Transaction_Date) = 4 THEN "04 - Apr"
           WHEN MONTH(Transaction_Date) = 5 THEN "05 - May"
           WHEN MONTH(Transaction_Date) = 6 THEN "06 - Jun"
           WHEN MONTH(Transaction_Date) = 7 THEN "07 - Jul"
           WHEN MONTH(Transaction_Date) = 8 THEN "08 - Aug"
           WHEN MONTH(Transaction_Date) = 9 THEN "09 - Sep"
           WHEN MONTH(Transaction_Date) = 10 THEN "10 - Oct"
           WHEN MONTH(Transaction_Date) = 11 THEN "11 - Nov"
           ELSE "12 - Dec"
       END AS Mth__filter,
Platform_Name,Site,SiteID, Impression_Source,Advertiser,Creative_size_Final
,SUM(Total_impressions) AS Total_impressions
,SUM(IMPS_Final) AS IMPS_Final 
//PlatformNAME, placement_name, Site, SiteID,  Ad_unit_ID_1, Ad_unit_ID_2, Advertiser, Creative_size, Creative_size_Final
//,Total_impressions
//,Imps_Final
FROM (

SELECT Transaction_Date,Platform_Name,Impression_Source,Site,SiteID,placement_name,Advertiser,Creative_size_Final
,SUM(Total_impressions) AS Total_impressions
,SUM(IMPS_Final) AS IMPS_Final 
FROM (TABLE_DATE_RANGE( ManagedServicesProcessed.APNXDFP_, TIMESTAMP('2016-06-01'), TIMESTAMP('2016-12-31')))
WHERE LOWER(Creative_size_Final) LIKE LOWER('%sizeless%') 
OR LOWER(placement_name) LIKE LOWER('%- hb%')
OR LOWER(placement_name) LIKE LOWER('%sizeless%')
GROUP BY Transaction_Date,Platform_Name,placement_name,Site,SiteID, Impression_Source,Advertiser,Creative_size_Final    
  ) AS A
  
GROUP BY Mth__filter,Transaction_Date,  Platform_Name,Site,SiteID, Impression_Source,Advertiser,Creative_size_Final//,Total_impressions,Imps_Final
ORDER BY SiteID ASC, Creative_size_Final ASC
  ) AS B

GROUP BY Mth__filter,Site,SiteID,Creative_size_Final,Platform_NAME
ORDER BY Creative_size_Final ASC

) AS C
GROUP BY Mth__filter,Site,SiteID,Creative_size_Final,Platform_NAME
,Total_impressions
,Imps_Final
,Imps_RunningTotal
ORDER BY Creative_size_Final ASC

) AS D
GROUP BY Mth__filter,Site,SiteID,Creative_size_Final,Platform_NAME
,Total_impressions
,Imps_Final
,Imps_RunningTotal
,Imps_RunningTotal2
,Imps_RunningTotal3
ORDER BY Creative_size_Final ASC

) AS E
GROUP BY Mth__filter,Site,SiteID,Creative_size_Final,Platform_NAME
,Total_impressions
,Imps_Final
,Imps_RunningTotal
ORDER BY SiteID,Creative_size_Final ASC

) AS F
GROUP BY Mth__filter,Site,SiteID,Creative_size_Final,Platform_NAME
,Total_impressions
,Imps_Final
,Imps_RunningTotal
,Imps_RunningTotal2
,Imps_RunningTotal3
,Imps_RunningTotal4
,Imps_RunningTotal5
ORDER BY Creative_size_Final ASC

) AS G
GROUP BY Mth__filter,Site,SiteID,Creative_size_Final,Platform_NAME
,Total_impressions
,Imps_Final
,Imps_RunningTotal
,Imps_RunningTotal6
,Imps_Final_Sizeless
ORDER BY Mth__filter, SiteID ASC, Creative_size_Final ASC

) AS H
GROUP BY Mth__filter,Site,SiteID,Creative_size_Final,Platform_NAME
ORDER BY Mth__filter, Site ASC, Creative_size_Final ASC

) AS I
GROUP BY Mth__filter,Site,SiteID,Creative_size_Final,Total_impressions,Imps_Final,Imps_Final_Sizeless,Platform_NAME
ORDER BY Mth__filter, Site ASC, Creative_size_Final ASC

//AS A
//JOIN ramp_reference.FXRates AS B
//ON A.TransactionDate = B.FXDate
//LIMIT 1000

//Save Output to: ManagedServicesProcessed.APNXDFP_HB_SiteID_Part1_20160701
