#APNXDFP_UNION_wFXRates_v3_20160601
#Step 1: UNION of ManagedServices_DFPGeneral.DFP_GENERAL_LevelALL + ManagedServices.APPNEXUS_NETWORK_JOIN
#Step 2: JOIN of ramp_reference.FXRates
#Date: 20160708 

SELECT
TransactionDate,
Ad_unit_1,
Ad_unit_2,
Ad_unit_3,
Line_item_type,
Creative_size,
Advertiser,
OrderName,
Salesperson,
Line_item,
Product_template, //New Col V3
Ad_unit_ID_1,
Ad_unit_ID_2,
Ad_unit_ID_3,
Advertiser_ID,
Order_ID, 
Salesperson_ID,
Line_item_ID,
Product_template_ID, //New Col V3
Order_start_date,
Order_end_date,
Order_PO_number,
Agency,
Trafficker,
Secondary_traffickers,
Delivery_pacing,
Frequency_cap,
Line_item_start_date,
Line_item_end_date,
Cost_type,
Rate_CA,
Goal_quantity,
Line_item_lifetime_impressions,
Line_item_lifetime_clicks,
Line_item_priority, 
Contracted_quantity,
Discount,
Booked_revenue_exclude_CPD_CA,
Name_Comments,
Audience_Segment,
LineItem_Type, //New Col V3
LineItem_Type_product, //New Col V3
Total_impressions,
Total_clicks,
Total_CPM_and_CPC_revenue_CA,
Delivery_indicator,
Total_Active_View_eligible_impressions,
Total_Active_View_viewable_impressions,
Ad_server_CPD_revenue_CA,
PlatformNAME, 
PlatformID,
axLineItemTypeNAME,
axLineItemTypeID,
axImpTypeNAME,
axImpTypeID,
axMediaTypeNAME,
axMediaTypeID,
CamTypeNAME,
CamTypeID,
RevTypeNAME,
RevTypeID,
ManagedNAME,
ManagedID,
AdTypeNAME,
AdTypeID,
TechFee,
DataSource,
LevelOne,
ID1,
ID2,
//Publisher,
//Added 20160724
//OLD AccountName AS Publisher,
APNXAccountName,
APNXPublisherName,
APNXPublisherID,
//End of Added 20160724
Site,
Site_ID,
Site_ID_calc,
Adv,
DisplayRevShare,
TCAdvertiserGroup,
TCBusinessUnit,
TCPublisher,
TCSite,
PARTNERGroup,
TCCampSrc,
IMPS_Final,
//-----------------------------
//FXRates Start
CAD2USD,
USD2CAD,

CASE WHEN PlatformID IN (1,3) THEN 'CAD'
ELSE 'USD' 
END AS CURRENCY,

//REVS IN CAD
CASE WHEN PlatformID IN (1,3) THEN  Total_CPM_and_CPC_revenue_CA
ELSE (Total_CPM_and_CPC_revenue_CA * USD2CAD)
END AS REVS_CPMCPC_CAD,

CASE WHEN PlatformID IN (1,3) THEN Ad_server_CPD_revenue_CA
ELSE (Ad_server_CPD_revenue_CA * USD2CAD)
END AS REVS_CPD_CAD,

//CAD REVS IN USD
CASE WHEN PlatformID IN (1,3) THEN (Total_CPM_and_CPC_revenue_CA * CAD2USD)
ELSE Total_CPM_and_CPC_revenue_CA 
END AS REVS_CPMCPC_CAD2USD,

CASE WHEN PlatformID IN (1,3) THEN  (Ad_server_CPD_revenue_CA * CAD2USD)
ELSE Ad_server_CPD_revenue_CA    
END AS REVS_CPD_CAD2USD,

//REVS IN USD
CASE WHEN PlatformID=2 THEN  Total_CPM_and_CPC_revenue_CA
ELSE (Total_CPM_and_CPC_revenue_CA * CAD2USD)
END AS REVS_CPMCPC_USD,
CASE WHEN PlatformID=2 THEN Ad_server_CPD_revenue_CA
ELSE (Ad_server_CPD_revenue_CA * CAD2USD)   
END AS REVS_CPD_USD,

//USD REVS IN CAD
CASE WHEN PlatformID=2 THEN  (Total_CPM_and_CPC_revenue_CA * USD2CAD)
ELSE Total_CPM_and_CPC_revenue_CA 
END AS REVS_CPMCPC_USD2CAD,

CASE WHEN PlatformID=2 THEN (Ad_server_CPD_revenue_CA * USD2CAD)
ELSE Ad_server_CPD_revenue_CA
END AS REVS_CPD_USD2CAD,
//FXRates End
//--------------------------------
FROM (
   
//--------------------------------
//UNION APNX DFP ONLY Start 
SELECT
    *
  FROM (
    SELECT
DATE(TransactionDate) AS TransactionDate,
Ad_unit_1,
Ad_unit_2,
Ad_unit_3,
Line_item_type,
Creative_size,
Advertiser,
OrderName,
Salesperson,
Line_item,
Product_template, //New Col V3
STRING(Ad_unit_ID_1) AS Ad_unit_ID_1,
STRING(Ad_unit_ID_2) AS Ad_unit_ID_2,
STRING(Ad_unit_ID_3) AS Ad_unit_ID_3,
INTEGER(Advertiser_ID) AS Advertiser_ID,
INTEGER(Order_ID) AS Order_ID, 
INTEGER(Salesperson_ID) AS Salesperson_ID,
INTEGER(Line_item_ID) AS Line_item_ID,
INTEGER(Product_template_ID) AS Product_template_ID, //New Col V3
DATE(Order_start_date) AS Order_start_date,
DATE(Order_end_date) AS Order_end_date,
Order_PO_number,
Agency,
Trafficker,
Secondary_traffickers,
Delivery_pacing,
Frequency_cap,
DATE(Line_item_start_date) AS Line_item_start_date,
DATE(Line_item_end_date) AS Line_item_end_date,
Cost_type,
FLOAT(Rate_CA) AS Rate_CA,
INTEGER(Goal_quantity) AS Goal_quantity,
INTEGER(Line_item_lifetime_impressions) AS  Line_item_lifetime_impressions,
INTEGER(Line_item_lifetime_clicks) AS  Line_item_lifetime_clicks,
INTEGER(Line_item_priority) AS Line_item_priority, 
INTEGER(Contracted_quantity) AS Contracted_quantity,
FLOAT(Discount) AS Discount,
FLOAT(Booked_revenue_exclude_CPD_CA) AS Booked_revenue_exclude_CPD_CA,
Name_Comments,
Audience_Segment,
LineItem_Type, //New Col V3
LineItem_Type_product, //New Col V3
INTEGER(Total_impressions) AS Total_impressions,
INTEGER(Total_clicks) AS Total_clicks,
FLOAT(Total_CPM_and_CPC_revenue_CA) AS Total_CPM_and_CPC_revenue_CA,
FLOAT(Delivery_indicator) AS Delivery_indicator,
INTEGER(Total_Active_View_eligible_impressions) AS Total_Active_View_eligible_impressions,
INTEGER(Total_Active_View_viewable_impressions) AS Total_Active_View_viewable_impressions,
FLOAT(Ad_server_CPD_revenue_CA) AS Ad_server_CPD_revenue_CA,
PlatformNAME, 
PlatformID,
axLineItemTypeNAME,
axLineItemTypeID,
axImpTypeNAME,
axImpTypeID,
axMediaTypeNAME,
axMediaTypeID,
CamTypeNAME,
CamTypeID,
RevTypeNAME,
RevTypeID,
ManagedNAME,
ManagedID,
AdTypeNAME,
AdTypeID,
TechFee,
DataSource,
LevelOne,
ID1,
ID2,
//Publisher,
//Added 20160724
//OLD AccountName AS Publisher,
APNXAccountName,
APNXPublisherName,
APNXPublisherID,
//End of Added 20160724
Site,
Site_ID,
Site_ID_calc,
Adv,
DisplayRevShare,
//INTEGER(REPLACE(REPLACE(DisplayRevShare,'-','0'),'%','')) AS DisplayRevShare,
TCAdvertiserGroup,
TCBusinessUnit,
TCPublisher,
TCSite,
PARTNERGroup,
TCCampSrc,
IMPS_Final
    FROM (TABLE_DATE_RANGE( ManagedServices_DFPGeneral.DFP_GENERAL_LevelALL_, TIMESTAMP('2016-06-01'), TIMESTAMP('2016-06-30')))),
    //FROM ManagedServices_DFPGeneral.DFP_GENERAL_LevelALL_20160701,
    (
    SELECT
      *
    FROM (
      SELECT
DATE(TransactionDate) AS TransactionDate,
Ad_unit_1,
Ad_unit_2,
Ad_unit_3,
Line_item_type,
Creative_size,
Advertiser,
OrderName,
Salesperson,
Line_item,
Product_template, //New Col V3
STRING(Ad_unit_ID_1) AS Ad_unit_ID_1,
STRING(Ad_unit_ID_2) AS Ad_unit_ID_2,
STRING(Ad_unit_ID_3) AS Ad_unit_ID_3,
INTEGER(Advertiser_ID) AS Advertiser_ID,
INTEGER(Order_ID) AS Order_ID, 
INTEGER(Salesperson_ID) AS Salesperson_ID,
INTEGER(Line_item_ID) AS Line_item_ID,
INTEGER(Product_template_ID) AS Product_template_ID, //New Col V3
DATE(Order_start_date) AS Order_start_date,
DATE(Order_end_date) AS Order_end_date,
Order_PO_number,
Agency,
Trafficker,
Secondary_traffickers,
Delivery_pacing,
Frequency_cap,
DATE(Line_item_start_date) AS Line_item_start_date,
DATE(Line_item_end_date) AS Line_item_end_date,
Cost_type,
FLOAT(Rate_CA) AS Rate_CA,
INTEGER(Goal_quantity) AS Goal_quantity,
INTEGER(Line_item_lifetime_impressions) AS  Line_item_lifetime_impressions,
INTEGER(Line_item_lifetime_clicks) AS  Line_item_lifetime_clicks,
INTEGER(Line_item_priority) AS Line_item_priority, 
INTEGER(Contracted_quantity) AS Contracted_quantity,
FLOAT(Discount) AS Discount,
FLOAT(Booked_revenue_exclude_CPD_CA) AS Booked_revenue_exclude_CPD_CA,
Name_Comments,
Audience_Segment,
LineItem_Type, //New Col V3
LineItem_Type_product, //New Col V3
INTEGER(Total_impressions) AS Total_impressions,
INTEGER(Total_clicks) AS Total_clicks,
FLOAT(Total_CPM_and_CPC_revenue_CA) AS Total_CPM_and_CPC_revenue_CA,
FLOAT(Delivery_indicator) AS Delivery_indicator,
INTEGER(Total_Active_View_eligible_impressions) AS Total_Active_View_eligible_impressions,
INTEGER(Total_Active_View_viewable_impressions) AS Total_Active_View_viewable_impressions,
FLOAT(Ad_server_CPD_revenue_CA) AS Ad_server_CPD_revenue_CA,
PlatformNAME, 
PlatformID,
axLineItemTypeNAME,
axLineItemTypeID,
axImpTypeNAME,
axImpTypeID,
axMediaTypeNAME,
axMediaTypeID,
CamTypeNAME,
CamTypeID,
RevTypeNAME,
RevTypeID,
ManagedNAME,
ManagedID,
AdTypeNAME,
AdTypeID,
TechFee,
DataSource,
LevelOne,
ID1,
ID2,
//Publisher,
//Added 20160724
//OLD AccountName AS Publisher,
APNXAccountName,
APNXPublisherName,
APNXPublisherID,
//End of Added 20160724
Site,
Site_ID,
Site_ID_calc,
Adv,
DisplayRevShare,
//INTEGER(REPLACE(REPLACE(DisplayRevShare,'-','0'),'%','')) AS DisplayRevShare,
TCAdvertiserGroup,
TCBusinessUnit,
TCPublisher,
TCSite,
PARTNERGroup,
TCCampSrc,
IMPS_Final
      FROM (TABLE_DATE_RANGE( ManagedServices.APPNEXUS_NETWORK_JOIN_, TIMESTAMP('2016-06-01'), TIMESTAMP('2016-06-30')))))

//UNION APNX DFP ONLY End 
//--------------------------------
) AS A
JOIN ramp_reference.FXRates AS B
ON A.TransactionDate = B.FXDate

//LIMIT 10
//SAVE OUTPUT TO: ManagedServicesProcessed.APNXDFP_20160x01

